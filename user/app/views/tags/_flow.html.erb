window.onload = init;

function clickHandler(e)
{
//  alert("x:" + (e.clientX-canvas.offsetLeft+window.pageXOffset)
//        +" y:" + (e.clientY-canvas.offsetTop+window.pageYOffset) + " id:" + calcPosition(e) + " now:" + MYAPP.y);
  MYAPP.id = calcPosition(e);
//  MYAPP.id && (window.location = "/contents/" + MYAPP.id);
  MYAPP.id && (MYAPP.href = "/contents/preview/" + MYAPP.id) && (Lightview.show({
    href: MYAPP.href,
    rel: 'ajax'
  }));
}

function init()
{
  reload();
  MYAPP.intervalID && clearInterval(MYAPP.intervalID);
  canvas = document.getElementById('canvas');
  canvas.removeEventListener("click", clickHandler, false);
  canvas.addEventListener("click", clickHandler, false);
  context2D = canvas.getContext('2d');
  context2D.clearRect(0, 0, canvas.width, canvas.height);
  MYAPP.intervalID = setInterval(draw, 2000 / MYAPP.FPS);
}

function calcPosition(e)
{
  var pos_y = e.clientY-canvas.offsetTop - MYAPP.y + window.pageYOffset;
  var pos_x = e.clientX-canvas.offsetLeft + window.pageXOffset;

  for (var i=0; i < MYAPP.content.length; i++)
  {
    for (var j=0; j < 3; j++)
    {
      if ((pos_x >= MYAPP.content[i].start_x) && (pos_x <= (MYAPP.content[i].start_x + MYAPP.content[i].width)) && (pos_y >= MYAPP.content[i].start_y + j*MYAPP.loop) && (pos_y <= (MYAPP.content[i].start_y + MYAPP.content[i].height + j*MYAPP.loop)))
      {
        return MYAPP.content[i].id;
      }
    }
  }

  return false;

}

